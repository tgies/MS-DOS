# DOS Message Extraction Tools

Experimental tools for extracting and reconstructing localized message files from MS-DOS executables.

> **NOTE:** These tools are in a very early experimental state. The end-to-end process of extracting messages from a DOS binary, reconstructing a .MSG file, and building DOS with that .MSG file has not been tested.

## Overview

MS-DOS 4.0+ uses a structured message system where all user-facing text (errors, prompts, status messages) is compiled into executables via the BUILDMSG.EXE tool. These tools reverse that process to extract localized messages from international DOS binaries.

## Coverage

Fully supports 85-90% of user-facing text, including all command/utility messages, shared common messages in USA-MS.MSG, extended error descriptions, and command parser error messages.

Not currently supported:
- SELECT installer UI text (~3,500 lines in USA.INF format)
- Help files (.HLP format)
- Hardcoded system strings (CONFIG.SYS directives, switches, etc.)

## Tools

### 1. parse_cl_files.py

Parses message class (.CL*) assembly files generated by BUILDMSG.

```bash
python3 tools/parse_cl_files.py format.clb
```

**Output:** Human-readable list of message IDs and text

**Use case:** Understanding the structure of English message files

### 2. dos_msg_extract.py

Standalone message extractor â€” scans a DOS executable for message class
structures and dumps all messages found, without needing a .CL* reference file.

```bash
python3 tools/dos_msg_extract.py FORMAT.COM
```

**Output:** Human-readable report of all message classes and messages

**Use case:** Quick inspection of any DOS 4.x executable's embedded messages

### 3. extract_localized_messages.py

Extracts localized messages from DOS executables by finding the binary
message structures defined in .CL* files.

```bash
python3 tools/extract_localized_messages.py format.clb dutch_format.com > dutch_format.msg
```

**Output:** BUILDMSG-compatible .MSG file

**Use case:** Reconstructing localized message files from international DOS binaries

## How It Works

### Binary Message Structure

DOS utilities embed messages in a structured format:

```
Class Header (4 bytes):
  [0]   Class ID (01h=EXTEND, 02h=PARSE, 0Ah=CLASS_A, FFh=UTILITY)
  [1-2] Expected DOS Version (00 04 = DOS 4.00, little-endian)
  [3]   Message Count

Message ID Table (4 bytes per message):
  [0-1] Message ID (little-endian)
  [2-3] Offset to message text (self-relative, little-endian)

Message Data (variable length):
  [0]   Length byte
  [1..N] Message text (CP437/CP850 encoded)
```

### Extraction Process

1. Parse English .CL* file to learn:
   - Class ID
   - Expected message count
   - Expected message IDs

2. Scan localized binary for class header matching:
   - Same class ID
   - Same message count
   - DOS 4.00 version signature

3. Verify structure:
   - Message IDs match expected set
   - Offsets point to valid length-prefixed strings
   - Text is mostly printable ASCII

4. Extract messages:
   - Follow self-relative offsets
   - Read length-prefixed strings
   - Decode as CP850 (multilingual) or CP437 (US)

5. Export as .MSG file compatible with BUILDMSG

## Tested Utilities

Successfully extracts 100% of messages from:
- COMMAND.COM (32 messages)
- FORMAT.COM (20 messages)
- CHKDSK.COM (19 messages)
- MODE.COM (28 messages)
- FDISK.EXE (6 messages)
- DEBUG.COM (4 messages)
- KEYB.COM (18 messages)
- SYS.COM (1 message)

## Usage Example: Extracting Dutch DOS Messages

```bash
# 1. Download Dutch MS-DOS 4.01 from archive.org
# 2. Extract executables from Dutch disk images

# 3. Extract messages from each utility
python3 tools/extract_localized_messages.py \
    v4.0/src/CMD/FORMAT/format.clb \
    dutch_dos/FORMAT.COM \
    > nl-NL/format.msg

python3 tools/extract_localized_messages.py \
    v4.0/src/CMD/COMMAND/command.cla \
    dutch_dos/COMMAND.COM \
    > nl-NL/command.msg

# 4. Repeat for all 48 utilities
# 5. Combine into complete NL-NL.MSG file
```

## Localization Coverage by Utility Category

| Category | Utilities | Classes | Messages |
|----------|-----------|---------|----------|
| Commands | 37        | 133     | 876      |
| Devices  | 5         | 15      | 50       |
| Core     | 1         | 4       | 22       |
| **Total** | **48**   | **152** | **948**  |

Plus 98 shared messages in COMMON section = 1,046 total

## Technical Details

### Character Encoding

Messages are typically encoded as:
- CP437 - Original IBM PC character set (US English)
- CP850 - Multilingual (Western Europe)
- CP860 - Portuguese
- CP862 - Hebrew
- CP863 - Canadian French
- CP864 - Arabic
- CP865 - Nordic

The extractor tries CP850 first, then CP437, then Latin-1 as fallback (this behavior is arbitrary and might need to be changed for some targets.)

### Message Classes

| Class ID | Name | Purpose |
|----------|------|---------|
| 0x01 | EXTEND | Extended error messages (INT 21h errors) |
| 0x02 | PARSE | Command-line parse errors |
| 0x0A | CLASS_A | Utility-specific messages (class A) |
| 0x0B | CLASS_B | Utility-specific messages (class B) |
| 0x0C | CLASS_C | Utility-specific messages (class C) |
| 0xFF | UTILITY | Main utility messages |

### Message Format in .MSG Files

```
0085
UTILITY   0012 0001
0015 U 0000 "Parameters not supported",CR,LF
0016 U 0000 "Format terminated",CR,LF
```

Where:
- `0085` = Message file format version
- `UTILITY` = Class name
- `0012` = Message count (hex)
- `0001` = Reserved
- `0015` = Message ID (hex)
- `U 0000` = Flags
- String with CR/LF markers

## Limitations

- Only works on DOS 4.0+, only tested on 4.0 from this source tree - Earlier DOS versions used different message systems
- Requires .CL* reference files - Need English source to know structure
- SELECT installer not supported - Uses different format (USA.INF)
- Help files not supported - Uses separate .HLP format

## Future Enhancements

Possible extensions:
- SELECT .INF file parser/extractor
- .HLP file parser
- Automated batch extraction from disk images
- Message file merger (combining multiple utilities)
- Validation against retail DOS versions

## Credits

Reverse-engineered by [tgies](https://github.com/tgies) from MS-DOS 4.0 source code released by Microsoft:
https://github.com/microsoft/MS-DOS
