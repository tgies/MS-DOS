name: Release MS-DOS 4

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release tag (default: short commit SHA)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dosemu2
        run: |
          sudo add-apt-repository -y ppa:dosemu2/ppa
          sudo apt-get update
          sudo apt-get install -y dosemu2

      - name: Build DOS 4
        run: |
          cd v4.0
          timeout 3600 ./mak.sh

      - name: Package artifacts
        run: |
          mkdir -p dist
          cp v4.0/*.sys v4.0/*.com v4.0/*.exe dist/ 2>/dev/null || true
          cp v4.0/*.cpi v4.0/*.pro v4.0/*.dat v4.0/*.prt v4.0/*.hlp dist/ 2>/dev/null || true
          cd dist && zip -r ../dos4-binaries.zip . && cd ..

      - name: Set release version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "tag=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            --title "MS-DOS 4 ${{ steps.version.outputs.tag }}" \
            --generate-notes \
            dos4-binaries.zip
